syntax = "proto3";

import "google/protobuf/any.proto";

option csharp_namespace = "GrpcChannel.Protocol.Protos";

package channel;

// Bidirectional duplex service supporting full-duplex RPC
// Both client and server can send requests and receive correlated responses
service DuplexService {
  // Control channel: bidirectional stream for RPC and notifications
  rpc Open(stream ProtocolDataUnit) returns (stream ProtocolDataUnit);

  // Data channel: high-throughput server-side streaming
  // Client subscribes with a request, server streams data back
  // Use this for high-volume data that would otherwise flood the control channel
  rpc Subscribe(DataStreamRequest) returns (stream DataStreamMessage);
}

// Protocol Data Unit (PDU) - unified message envelope for bidirectional communication
//
// Message type inference:
// - Request:      method is set, correlation_id is set
// - Response:     method is empty, correlation_id matches a pending request
// - Notification: method is set, correlation_id is empty
message ProtocolDataUnit {
  // Unique message identifier
  string id = 1;

  // Correlation ID for request/response matching
  // - Requests: set by sender, used to match response
  // - Responses: echoes the request's correlation_id
  // - Notifications: empty (fire-and-forget)
  string correlation_id = 2;

  // Method or topic name
  // - Requests: method/handler to invoke
  // - Responses: empty
  // - Notifications: topic name
  string method = 3;

  // Message payload (Any allows typed messages)
  google.protobuf.Any payload = 4;

  // Response status (only for responses)
  StatusCode status = 5;

  // Error details (only for failed responses)
  ProblemDetails problem = 6;

  // Request timeout in milliseconds (only for requests)
  int32 timeout_ms = 7;

  // Processing duration in milliseconds (only for responses)
  int64 duration_ms = 8;

  // Message timestamp (UTC milliseconds since epoch)
  int64 timestamp_utc = 9;

  // Additional headers/metadata
  map<string, string> headers = 10;
}

// Problem details for error responses (similar to RFC 7807)
// https://datatracker.ietf.org/doc/html/rfc7807
message ProblemDetails {
  // URI reference identifying the problem type
  // e.g., "https://example.com/errors/validation-failed"
  string type = 1;

  // Short, human-readable summary of the problem
  // e.g., "Validation Failed"
  string title = 2;

  // HTTP-style status code (for interoperability)
  int32 status = 3;

  // Human-readable explanation specific to this occurrence
  // e.g., "The 'email' field must be a valid email address"
  string detail = 4;

  // URI reference identifying the specific occurrence
  // e.g., "https://example.com/errors/12345"
  string instance = 5;

  // Application-specific error code
  string code = 6;

  // Stack trace (only in development/debug mode)
  string trace = 7;

  // Additional error properties
  map<string, string> extensions = 8;

  // Nested/inner errors for error chains
  repeated ProblemDetails errors = 9;
}

// Wrapper for arbitrary serialized payloads (non-protobuf types)
// Used when sending C# records, POCOs, or other serializable types
message RawPayload {
  // Serialized payload data
  bytes data = 1;

  // Fully qualified type name (e.g., "MyNamespace.MyRecord")
  string type_name = 2;

  // Content type / media type (e.g., "application/json", "application/x-msgpack")
  string content_type = 3;
}

// Response status codes
enum StatusCode {
  STATUS_CODE_UNSPECIFIED = 0;
  STATUS_CODE_OK = 1;
  STATUS_CODE_ERROR = 2;
  STATUS_CODE_NOT_FOUND = 3;
  STATUS_CODE_TIMEOUT = 4;
  STATUS_CODE_CANCELLED = 5;
  STATUS_CODE_UNAUTHORIZED = 6;
  STATUS_CODE_INVALID_REQUEST = 7;
  STATUS_CODE_UNAVAILABLE = 8;
  STATUS_CODE_INTERNAL = 9;
}

// ============================================================================
// HIGH-THROUGHPUT DATA STREAMING
// ============================================================================

// Request to subscribe to a data stream
// Client sends this once, server streams messages back
message DataStreamRequest {
  // Unique identifier for this stream subscription
  string stream_id = 1;

  // Topic/channel to subscribe to (e.g., "market-data", "events", "logs")
  string topic = 2;

  // Optional filter expression (topic-specific)
  string filter = 3;

  // Starting position (topic-specific, e.g., sequence number, timestamp)
  string cursor = 4;

  // Maximum messages per second (0 = unlimited)
  int32 max_rate = 5;

  // Buffer size hint for the server
  int32 buffer_size = 6;

  // Additional subscription options
  map<string, string> options = 7;
}

// High-throughput data stream message
// Optimized for volume - minimal overhead per message
message DataStreamMessage {
  // Stream identifier (matches the subscription)
  string stream_id = 1;

  // Monotonically increasing sequence number within the stream
  int64 sequence = 2;

  // Message payload
  google.protobuf.Any payload = 3;

  // Message timestamp (UTC milliseconds since epoch)
  int64 timestamp_utc = 4;

  // Partition/shard key (for ordered delivery within partition)
  string partition_key = 5;

  // Message type hint (for client-side routing)
  string message_type = 6;

  // True if this is the final message in the stream
  bool is_complete = 7;

  // Error if the stream encountered a problem
  ProblemDetails error = 8;
}
